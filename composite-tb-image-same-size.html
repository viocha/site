<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>刷单图片生成</title>
  <script type="module">
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');

    form.onchange = async (event) => {
      const contentFile = contentImgInput.files[0];
      const coverFile = coverImgInput.files[0];

      if (contentFile && coverFile) {
        const contentImg = await fileToImg(contentFile),
            coverImg = await fileToImg(coverFile);

        canvas.width = contentImg.width;
        canvas.height = contentImg.height;
        ctx.drawImage(contentImg, 0, 0);

        let sBox;
        if (event.target.nodeName === 'SELECT') {
          const type = +clipType.value;
          sBox = getClipBox(coverImg, type);
        } else {
          sBox = getClipBox(coverImg);
        }

        ctx.drawImage(coverImg, ...sBox, ...sBox);

        canvas.toBlob(blob => {
          outputImg.src = URL.createObjectURL(blob);
          info.textContent = `图片尺寸：宽${canvas.width}，高${canvas.height}`;
          imgDownload.download = `Screenshot_${Date.now()}.jpg`;  //todo:日期格式化
          imgDownload.href = outputImg.src;
          imgDownload.textContent = '点击下载';
        });
      }

    };

    async function fileToImg(file) {
      const img = document.createElement('img');
      img.src = URL.createObjectURL(file);
      return new Promise(resolve => {
        img.onload = () => {
          resolve(img);
        };
      });
    }

    function getClipBox(coverImg, type) {
      const boxes = [
        [45, 620, 986, 172],
        [0, 0, coverImg.width, 75],
      ];
      let sxValue = sx.value,
          syValue = sy.value,
          sWithValue = sWith.value,
          sHeightValue = sHeight.value;
      if (sxValue + syValue + sWithValue + sHeightValue === '') {
        type = 0;
      }
      if (typeof type === 'number') {
        sxValue = sx.value = boxes[type][0];
        syValue = sy.value = boxes[type][1];
        sWithValue = sWith.value = boxes[type][2];
        sHeightValue = sHeight.value = boxes[type][3];
      }
      return [sxValue, syValue, sWithValue, sHeightValue];
    }


  </script>
  <style>
    form > div {
      margin: .3em 0;
    }

    .number {
      width: 6em;
      margin-right: 1em;
    }

    #outputImg {
      width: 80vw;
    }
  </style>
</head>
<body>
<form id="form">
  <div>
    <label for="contentImgInput">内容截图：</label>
    <input accept="image/*" id="contentImgInput" name="contentImgInput"
           type="file">
  </div>
  <div>
    <label for="coverImgInput">覆盖截图：</label>
    <input accept="image/*" id="coverImgInput" name="coverImgInput" type="file">
  </div>
  <div>
    <label for="clipType">剪切类型：</label>
    <select id="clipType" name="clipType">
      <option value="0">待收货</option>
      <option value="1">时间</option>
    </select>
  </div>
  <div>
    <label for="sx">sx：</label>
    <input class="number" id="sx" name="sx" type="number">
    <label for="sy">sy：</label>
    <input class="number" id="sy" name="sy" type="number">
    <label for="sWith">sWith：</label>
    <input class="number" id="sWith" name="sWith" type="number">
    <label for="sHeight">sHeight：</label>
    <input class="number" id="sHeight" name="sHeight" type="number">
  </div>
  <output>
    <div id="info"></div>
    <div><a id="imgDownload"></a></div>
    <div><img alt="" id="outputImg" src=""></div>
  </output>
</form>


</body>
</html>